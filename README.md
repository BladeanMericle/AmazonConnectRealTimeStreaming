# Amazon Connect Real Time Streaming

## 概要

「[AWS音声活用術！Amazon Connect実践入門](https://nextpublishing.jp/book/11777.html)」のサンプルコードです。

Amazon Connectのライブメディアストリーミングの機能を利用し、通話の音声を録音できるようにしました。



## 環境構築

### IAM

1. AWS Lambda用のポリシーを作成します。ポリシーの内容は[SendContactFlowEventPolicy.json](SendContactFlowEventPolicy.json)となります。
2. このプログラム用のポリシーを作成します。ポリシーの内容は[RealTimeStreamingPolicy.json](RealTimeStreamingPolicy.json)となります。
3. AWS Lambda用のロールを作成します。AWS Lambda用に作成したポリシーを適用します。
4. このプログラム用ユーザーを作成し、アクセスキーIDとシークレットアクセスキーを控えます。このプログラム用に作成したポリシーを適用します。

### Kinesis Data Streams

シャード数1個のストリームを作成します。
※Kinesis Data Streamsのストリームは、使わなくなったらすぐに削除するようにしてください。存在しているだけで料金が発生するサービスです。

### AWS Lambda

AWS Lambda用のポリシーを適用したロールを使用し、[SendContactFlowEvent.js](SendContactFlowEvent.js)の関数を作成します。
環境変数"STREAM_NAME"を追加し、Kinesis Data Streamsに作成したストリームのストリーム名を値に設定します。

### Amazon Connect

- Amazon Connectのホーム画面を開き、インスタンスエイリアスのリンクをクリックします。
  - [データストレージ]をクリックします。
    1. ライブメディアストリーミングの[編集]をクリックします。
    2. [ライブメディアストリーミングの有効化]にチェックを入れます。
    3. [プレフィックス]に適当なプレフィックスを設定します。
    4. [KMSマスターキー]に"aws/kinesisvideo"を選択します。
    5. [データ保持期間]を1時間に設定します。
    6. [保存]をクリックします。
  - [問い合わせフロー]をクリックします。
    1. AWS Lambdaの[関数]から、作成した関数を選択します。
    2. [+Lambda関数の追加]をクリックします。
- Amazon Connectのログイン画面を開き、問い合わせフローの編集権限を持ったユーザーでログインします。
  - ルーティングの[問い合わせフロー]をクリックします。
    1. "Default Agent Whisper"をクリックします。
    2. [メディアストリーミングの開始]を配置します。
       - [顧客から]と[顧客へ]の両方にチェックを入れます。
    3. [AWS Lambda関数を呼び出す]を配置します。
       - [関数のARN]に"関数を選択する"を選択し、さらに作成した関数を選択します。
    4. (既存の処理)→[メディアストリーミングの開始]→[AWS Lambda関数を呼び出す]→[終了フロー/再開]となるようにブロックを繋ぎ直します。エラーの分岐は[終了フロー/再開]へ繋いでください。

### プログラム

1. JVMがインストールされてなければインストールします。
2. "releases"から最新バージョンのプログラムをダウンロードします。
3. "properties.xml"を編集します。
   - キー"streamname"の値をKinesis Data Streamsのストリーム名を設定します。
4. "run.bat"を編集します。
   - 環境変数"JAVA_HOME"に、JVMのインストール先を設定します。
   - 環境変数"AWS_ACCESS_KEY_ID"に、このプログラム用ユーザーのアクセスキーIDを設定します。
   - 環境変数"AWS_SECRET_ACCESS_KEY"に、このプログラム用ユーザーのシークレットアクセスキーを設定します。



## 使用方法

1. "run.bat"を実行します。
2. コンソールとウインドウが表示されます。
3. コンソールに"Kinesis Data Streams からのデータの受信を開始します。"と表示されるまで待ちます。
4. Amazon Connectへ電話をかけ、CCPで応答します。
5. ウインドウに通話中の音声の周波数スペクトルが表示されます。
6. 通話を終了すると"audio"フォルダが自動で作成され、その中に録音開始日時の名前で音声ファイルが作成されます。1通話につき2個の音声ファイルが作成され、末尾が"-cu"はお客様側の音声、末尾が"-op"はオペレーター側の音声となります。音声の形式はPCM、8kHz、16bit、モノラルです。



## 注意事項

- このプログラムでは45分までしか録音できません。Kinesis Video StreamsのGetMediaというAPIが、一度に45分までしか音声を取得できないためです。45分以上録音したい場合は、GetMediaの再接続処理を実装する必要があるようです。



## 更新履歴

### 0.1.0

- 周波数スペクトルの表示機能を追加しました。

### 0.0.1

- 初期バージョンです。
